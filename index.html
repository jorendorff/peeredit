<!doctype html>
<html>
  <head>
    <title>peeredit - conflict-free collaborative editing</title>
    <style>
      #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="editor"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="lib/rga.js"></script>
    <script>
      $(function (event) {
        function tieToAceEditor(rga, editor) {
          var panic = false;
          var ignoreEvents = [];

          // The flow of operations is bidirectional. First, implement delivery
          // of ops from the RGA to the editor.
          var rgaToEditorPipe = {
            _downstream: function (source, op) {
              if (panic)
                return;
              console.log("received from rga, from socket:", op);

              switch (op.type) {
              case "addRight":
                var loc = rga.getRowColumnAfter(op.t);
                ignoreEvents.push({
                  action: "insert",
                  start: loc,
                  lines: op.w.atom.split("\n")
                });
                editor.getSession().insert(loc, op.w.atom);
                break;

              case "remove":
                console.log("remove:", op.t, " from:", rga);
                var loc = rga.getRowColumnBefore(op.t);
                ignoreEvents.push({
                  action: "remove",
                  start: loc
                });
                var removingNewline = editor.getSession().doc.getLine(loc.row).length === loc.column;
                editor.getSession().remove({
                  start: loc,
                  end: removingNewline
                       ? {row: loc.row + 1, column: 0}
                       : {row: loc.row, column: loc.column + 1}
                });
                break;
              }
            }
          };
          rga._subscribers.push(rgaToEditorPipe);

          // And second, implement the flow of ops from the editor to the RGA,
          // being careful not to forward events generated by ops that came
          // from the RGA in the first place (!).
          editor.setValue(rga.text());
          editor.getSession().on("change", function (e) {
            if (panic)
              return;
            console.log("change", e);
            if (ignoreEvents.length > 0) {
              if (ignoreEvents[0].action === e.action &&
                  ignoreEvents[0].start.row === e.start.row &&
                  ignoreEvents[0].start.column === e.start.column &&
                  (!("lines" in ignoreEvents[0]) ||
                   ignoreEvents[0].lines.join("\n") === e.lines.join("\n"))) {
                console.log("ignoring event, because it came from the editor");
                ignoreEvents.shift();
                return;
              } else {
                console.log("Uh oh, something weird happened. Expected event:", ignoreEvents[0]);
                if (ignoreEvents.length > 1)
                  console.log("and", ignoreEvents.length - 1, "other events:", ignoreEvents.slice(1));
                console.log("Received event:", e);
                panic = true;
                alert("updates disabled");
                return;
              }
            }
            if (e.action === "insert") {
              rga.insertRowColumn(rgaToEditorPipe, e.start.row, e.start.column, e.lines.join("\n"));
            } else if (e.action === "remove") {
              rga.removeRowColumn(rgaToEditorPipe, e.start.row, e.start.column, e.lines.join("\n").length);
            }
          });
        }

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");  // monokai, ambiance, solarized_dark, tomorrow_night
        editor.getSession().setMode("ace/mode/javascript");

        var socket = io();
        var rga;
        socket.on("welcome", function (event) {
          rga = new RGA(event.id, event.history);
          RGA.tieToSocket(rga, socket);
          tieToAceEditor(rga, editor);
        });
      });
    </script>
  </body>
</html>
